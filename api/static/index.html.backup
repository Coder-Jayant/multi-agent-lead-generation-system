<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generator AI - MongoDB Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1em;
        }

        .tabs {
            display: flex;
            background: #f7f7f7;
            border-bottom: 2px solid #e5e5e5;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #ececec;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.inactive {
            background: #ef4444;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .product-card {
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .product-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .product-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .product-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #999;
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leads-table th,
        .leads-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        .leads-table th {
            background: #f7f7f7;
            font-weight: 600;
            color: #333;
        }

        .leads-table tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-high {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .email-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .email-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
        }

        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select,
        .filter-bar input {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Lead Generator AI</h1>
            <p class="subtitle">MongoDB-Powered Lead Discovery & Management</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">üì¶ Products</button>
            <button class="tab" onclick="switchTab('generate')">üöÄ Generate Leads</button>
            <button class="tab" onclick="switchTab('leads')">üìä View Leads</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <h2 style="margin-bottom: 20px;">Product Management</h2>

            <div class="status-bar" id="products-status">
                <div class="status-item">
                    <div class="status-dot inactive" id="products-mongo-status"></div>
                    <span>MongoDB: <span id="products-mongo-text">Not Connected</span></span>
                </div>
                <div class="status-item">
                    <span>Products: <strong id="products-count">0</strong></span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                <!-- Create Product Form -->
                <div>
                    <h3 style="margin-bottom: 15px;">Create New Product</h3>
                    <div class="form-group">
                        <label>Product Name*</label>
                        <input type="text" id="product-name" placeholder="AI Voicebot Platform">
                    </div>
                    <div class="form-group">
                        <label>Description*</label>
                        <textarea id="product-description" placeholder="Describe your product or service..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Personas (comma-separated)</label>
                        <input type="text" id="product-personas" placeholder="C-Level, VP/Director, IT Manager">
                    </div>
                    <div class="form-group">
                        <label>Industries (comma-separated)</label>
                        <input type="text" id="product-industries" placeholder="Technology, Healthcare, Finance">
                    </div>
                    <div class="form-group">
                        <label>Regions (comma-separated)</label>
                        <input type="text" id="product-regions" placeholder="North America, Europe, Asia">
                    </div>
                    <button class="btn" onclick="createProduct()">Create Product</button>
                </div>

                <!-- Products List -->
                <div>
                    <h3 style="margin-bottom: 15px;">Your Products</h3>
                    <div id="products-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Loading products...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generate Leads Tab -->
        <div id="generate" class="tab-content">
            <h2 style="margin-bottom: 20px;">Generate Leads for Product</h2>

            <div class="warning" id="generate-warning" style="display: none;">
                <strong>‚ö†Ô∏è No Products Found</strong><br>
                Please create a product first in the Products tab.
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Select Product*</label>
                    <select id="generate-product-select">
                        <option value="">Select a product...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Target Lead Count</label>
                    <input type="number" id="generate-target" value="30" min="5" max="100">
                </div>
                <div class="form-group">
                    <label>Max Iterations</label>
                    <input type="number" id="generate-iterations" value="5" min="1" max="10">
                </div>
            </div>

            <div class="form-group">
                <label>Additional Context (Optional)</label>
                <textarea id="generate-context" placeholder="Any additional targeting preferences..."></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="generateLeads()" id="start-generation-btn">üöÄ Start Lead
                    Generation</button>
                <button class="btn" onclick="cancelGeneration()" id="stop-generation-btn"
                    style="background: #ef4444; display: none;">
                    üõë Stop Generation
                </button>
            </div>

            <div id="generate-progress" style="display: none; margin-top: 30px;">
                <div class="status-bar">
                    <div class="status-item">
                        <div style="font-weight: 600;">Generation in progress...</div>
                    </div>
                </div>
                <div id="generate-log"
                    style="background: #f7f7f7; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                </div>
            </div>
        </div>

        <!-- View Leads Tab -->
        <div id="leads" class="tab-content">
            <h2 style="margin-bottom: 20px;">View & Filter Leads</h2>

            <div class="filter-bar">
                <select id="leads-product-filter" onchange="filterLeads()">
                    <option value="">All Products</option>
                </select>
                <select id="leads-score-filter" onchange="filterLeads()">
                    <option value="0">All Scores</option>
                    <option value="80">High Quality (80+)</option>
                    <option value="60">Medium+ (60+)</option>
                    <option value="40">Low+ (40+)</option>
                </select>
                <select id="leads-persona-filter" onchange="filterLeads()">
                    <option value="">All Personas</option>
                    <option value="C-Level">C-Level</option>
                    <option value="VP/Director">VP/Director</option>
                    <option value="IT Manager">IT Manager</option>
                </select>
                <button class="btn-secondary btn" onclick="loadLeads()">üîÑ Refresh</button>
            </div>

            <div id="leads-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Loading leads...</p>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <h2 style="margin-bottom: 20px;">MongoDB Configuration</h2>

            <div class="status-bar" id="config-status">
                <div class="status-item">
                    <div class="status-dot inactive" id="config-mongo-status"></div>
                    <span>Status: <span id="config-mongo-text">Not Connected</span></span>
                </div>
            </div>

            <div class="form-group">
                <label>MongoDB Connection URI*</label>
                <input type="text" id="config-mongo-uri"
                    value="mongodb://leadgen_admin:LeadGen%402026Secure@49.50.117.66:27017/"
                    placeholder="mongodb://user:pass@host:port/">
            </div>

            <div class="form-group">
                <label>Database Name*</label>
                <input type="text" id="config-db-name" value="leadgen" placeholder="leadgen">
            </div>

            <div style="display: flex; gap: 15px;">
                <button class="btn" onclick="configureMongoDB()">üíæ Save & Connect</button>
                <button class="btn-secondary btn" onclick="checkMongoHealth()">üè• Check Health</button>
            </div>

            <div id="config-result" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        let selectedProduct = null;
        let allProducts = [];

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Load data when switching tabs
            if (tabName === 'products') {
                loadProducts();
            } else if (tabName === 'leads') {
                loadLeads();
                loadProductFilters();
            } else if (tabName === 'generate') {
                loadProductsForGenerate();
            } else if (tabName === 'config') {
                checkMongoHealth();
            }
        }

        // MongoDB Configuration
        async function configureMongoDB() {
            const uri = document.getElementById('config-mongo-uri').value;
            const dbName = document.getElementById('config-db-name').value;

            if (!uri || !dbName) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/api/config/mongodb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mongo_uri: uri,
                        database_name: dbName
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('config-result').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Success!</strong><br>${data.message}
                        </div>
                    `;
                    checkMongoHealth();
                } else {
                    document.getElementById('config-result').innerHTML = `
                        <div class="warning">
                            <strong>‚ùå Error</strong><br>${data.message || 'Configuration failed'}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('config-result').innerHTML = `
                    <div class="warning">
                        <strong>‚ùå Error</strong><br>${error.message}
                    </div>
                `;
            }
        }

        async function checkMongoHealth() {
            try {
                const response = await fetch('/api/config/mongodb/health');
                const data = await response.json();

                const isHealthy = data.status === 'healthy';

                // Update all status indicators
                ['config', 'products'].forEach(prefix => {
                    const statusDot = document.getElementById(`${prefix}-mongo-status`);
                    const statusText = document.getElementById(`${prefix}-mongo-text`);

                    if (statusDot && statusText) {
                        if (isHealthy) {
                            statusDot.classList.remove('inactive');
                            statusText.textContent = `Connected (${data.server_version || 'unknown'})`;
                        } else {
                            statusDot.classList.add('inactive');
                            statusText.textContent = data.message || 'Not Connected';
                        }
                    }
                });

                if (document.getElementById('config').classList.contains('active')) {
                    if (isHealthy) {
                        document.getElementById('config-result').innerHTML = `
                            <div class="success">
                                <strong>‚úÖ MongoDB is Healthy</strong><br>
                                Version: ${data.server_version}<br>
                                Database: ${data.database}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // Product Management
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                allProducts = data.products || [];
                document.getElementById('products-count').textContent = allProducts.length;

                const listContainer = document.getElementById('products-list');

                if (allProducts.length === 0) {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>No products yet. Create your first product!</p>
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = allProducts.map(product => `
                        <div class="product-card" onclick="selectProduct('${product.id}')">
                            <div class="product-name">${product.name}</div>
                            <div class="product-description">${product.description}</div>
                            <div class="product-meta">
                                <span>üìä Leads: ${product.lead_count}</span>
                                <span>üìÖ ${new Date(product.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('');
                }

                checkMongoHealth();
            } catch (error) {
                document.getElementById('products-list').innerHTML = `
                    <div class="warning">Failed to load products: ${error.message}</div>
                `;
            }
        }

        function selectProduct(productId) {
            selectedProduct = productId;
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.product-card').classList.add('selected');
        }

        async function createProduct() {
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const personas = document.getElementById('product-personas').value;
            const industries = document.getElementById('product-industries').value;
            const regions = document.getElementById('product-regions').value;

            if (!name || !description) {
                alert('Please fill in name and description');
                return;
            }

            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        target_personas: personas ? personas.split(',').map(s => s.trim()) : [],
                        industries: industries ? industries.split(',').map(s => s.trim()) : [],
                        regions: regions ? regions.split(',').map(s => s.trim()) : []
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('‚úÖ Product created successfully!');
                    // Clear form
                    document.getElementById('product-name').value = '';
                    document.getElementById('product-description').value = '';
                    document.getElementById('product-personas').value = '';
                    document.getElementById('product-industries').value = '';
                    document.getElementById('product-regions').value = '';

                    // Reload products
                    loadProducts();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to create product: ' + error.message);
            }
        }

        // Load products for generate tab
        async function loadProductsForGenerate() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                const select = document.getElementById('generate-product-select');

                if (data.products && data.products.length > 0) {
                    select.innerHTML = '<option value="">Select a product...</option>' +
                        data.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    document.getElementById('generate-warning').style.display = 'none';
                } else {
                    select.innerHTML = '<option value="">No products available</option>';
                    document.getElementById('generate-warning').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }

        // Lead Generation (using existing endpoint)
        let currentEventSource = null;

        async function generateLeads() {
            const productId = document.getElementById('generate-product-select').value;
            const targetCount = parseInt(document.getElementById('generate-target').value);
            const maxIterations = parseInt(document.getElementById('generate-iterations').value);
            const context = document.getElementById('generate-context').value;

            if (!productId) {
                alert('Please select a product');
                return;
            }

            const productResponse = await fetch(`/api/products/${productId}`);
            const product = await productResponse.json();

            const progressDiv = document.getElementById('generate-progress');
            const logDiv = document.getElementById('generate-log');
            progressDiv.style.display = 'block';
            logDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">üöÄ Starting...</div>';

            let productDescription = product.description;
            if (context) productDescription += `\n\n${context}`;

            const eventSource = new EventSource(
                `/api/generate/stream?` + new URLSearchParams({
                    product_description: productDescription,
                    target_count: targetCount
                })
            );

            let leadCount = 0;
            let stepCount = 0;
            currentEventSource = eventSource;

            // Show stop button
            document.getElementById('start-generation-btn').style.display = 'none';
            document.getElementById('stop-generation-btn').style.display = 'block';

            eventSource.addEventListener('step', (e) => {
                const data = JSON.parse(e.data);
                stepCount++;
                const stepId = `step-${stepCount}`;
                const detailsHtml = `
                    <details style="margin: 8px 0; border-left: 3px solid #667eea; padding-left: 10px;">
                        <summary style="cursor: pointer; color: #667eea; font-weight: 600; padding: 5px 0;">
                            üîµ Step ${stepCount}: ${data.step || 'action'} - ${(data.message || '').substring(0, 80)}...
                        </summary>
                        <div style="margin-top: 8px; padding: 10px; background: #f3f4f6; border-radius: 5px; font-size: 13px;">
                            <div><strong>Type:</strong> ${data.step || 'action'}</div>
                            ${data.tool ? `<div><strong>Tool:</strong> <code>${data.tool}</code></div>` : ''}
                            <div style="margin-top: 5px;"><strong>Details:</strong><br>${data.message || 'Processing...'}</div>
                        </div>
                    </details>
                `;
                logDiv.innerHTML += detailsHtml;
                logDiv.scrollTop = logDiv.scrollHeight;
            });

            eventSource.addEventListener('observation', (e) => {
                const data = JSON.parse(e.data);
                const obsText = data.observation || '';
                const obsHtml = `
                    <details style="margin: 8px 0; border-left: 3px solid #10b981; padding-left: 10px;">
                        <summary style="cursor: pointer; color: #10b981; font-weight: 600; padding: 5px 0;">
                            üëÅÔ∏è Observation: ${obsText.substring(0, 60)}${obsText.length > 60 ? '...' : ''}
                        </summary>
                        <div style="margin-top: 8px; padding: 10px; background: #d1fae5; border-radius: 5px; font-size: 13px; white-space: pre-wrap;">
                            ${obsText}
                        </div>
                    </details>
                `;
                logDiv.innerHTML += obsHtml;
                logDiv.scrollTop = logDiv.scrollHeight;
            });

            eventSource.addEventListener('lead', async (e) => {
                const lead = JSON.parse(e.data);
                leadCount++;

                logDiv.innerHTML += `<div style="color: #f59e0b; margin: 5px 0;">üíæ Saving: ${lead.name}...</div>`;
                const saved = await saveLead(productId, lead);
                if (saved) {
                    const leadHtml = `
                        <details open style="margin: 10px 0; border-left: 4px solid #10b981; padding-left: 10px; background: #f0fdf4; padding: 10px; border-radius: 5px;">
                            <summary style="cursor: pointer; color: #10b981; font-weight: 700; padding: 5px 0;">
                                ‚úÖ Lead ${leadCount}: ${lead.name} (${lead.domain})
                            </summary>
                            <div style="margin-top: 10px; font-size: 13px;">
                                <div><strong>Domain:</strong> <a href="https://${lead.domain}" target="_blank">${lead.domain}</a></div>
                                ${lead.description ? `<div style="margin-top: 5px;"><strong>About:</strong> ${lead.description.substring(0, 200)}...</div>` : ''}
                                ${lead.emails && lead.emails.length > 0 ? `<div style="margin-top: 5px;"><strong>Emails:</strong> ${lead.emails.join(', ')}</div>` : ''}
                                ${lead.relevance_score ? `<div style="margin-top: 5px;"><strong>Relevance:</strong> ${lead.relevance_score}/100</div>` : ''}
                            </div>
                        </details>
                    `;
                    logDiv.innerHTML += leadHtml;
                } else {
                    logDiv.innerHTML += `<div style="color: #ef4444; margin: 5px 0;">‚ö†Ô∏è Duplicate: ${lead.name}</div>`;
                }
                logDiv.scrollTop = logDiv.scrollHeight;
            });

            eventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                logDiv.innerHTML += `<div style="color: #10b981; margin: 10px 0; padding: 10px; background: #d1fae5; border-radius: 5px; font-weight: 600;">üéâ Complete! ${data.total_leads} leads</div>`;
                eventSource.close();
                currentEventSource = null;
                document.getElementById('start-generation-btn').style.display = 'block';
                document.getElementById('stop-generation-btn').style.display = 'none';
                setTimeout(() => { loadProducts(); loadProductsForGenerate(); }, 1000);
            });

            eventSource.addEventListener('error', (e) => {
                logDiv.innerHTML += `<div style="color: #ef4444; margin: 10px 0; padding: 10px; background: #fee2e2; border-radius: 5px;">‚ùå Error</div>`;
                eventSource.close();
                currentEventSource = null;
                document.getElementById('start-generation-btn').style.display = 'block';
                document.getElementById('stop-generation-btn').style.display = 'none';
            });
        }

        async function cancelGeneration() {
            try {
                const response = await fetch('/api/generate/cancel', { method: 'POST' });
                const result = await response.json();

                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }

                const logDiv = document.getElementById('generate-log');
                logDiv.innerHTML += `<div style="color: #ef4444; margin: 10px 0; padding: 10px; background: #fee2e2; border-radius: 5px; font-weight: 600;">üõë ${result.message || 'Generation stopped'}</div>`;

                document.getElementById('start-generation-btn').style.display = 'block';
                document.getElementById('stop-generation-btn').style.display = 'none';
            } catch (error) {
                console.error('Failed to cancel:', error);
                alert('Failed to stop generation');
            }
        }

        async function saveLead(productId, lead) {
            try {
                const emailsWithPersona = (lead.emails || []).map(email => ({
                    email: email, confidence: 90, status: 'verified', persona: null
                }));
                const response = await fetch('/api/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        domain: lead.domain,
                        name: lead.name,
                        description: lead.description || lead.summary || '',
                        url: lead.url || `https://${lead.domain}`,
                        emails: emailsWithPersona,
                        email_source: 'scraped'
                    })
                });
                const result = await response.json();
                return result.status === 'success';
            } catch (error) {
                console.error('Error saving lead:', error);
                return false;
            }
        }

        // Load and filter leads
        async function loadLeads() {
            const productId = document.getElementById('leads-product-filter').value;
            const minScore = parseInt(document.getElementById('leads-score-filter').value);
            const persona = document.getElementById('leads-persona-filter').value;

            let url = '/api/leads/filter?';
            if (productId) url += `product_id=${productId}&`;
            if (minScore) url += `min_score=${minScore}&`;
            if (persona) url += `persona=${persona}&`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                const container = document.getElementById('leads-container');

                if (!data.leads || data.leads.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>No leads found matching your filters</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <table class="leads-table">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Domain</th>
                                    <th>Emails</th>
                                    <th>Qualification</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.leads.map(lead => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: 600;">${lead.name}</div>
                                            <div style="font-size: 12px; color: #666;">${lead.description?.substring(0, 60)}...</div>
                                        </td>
                                        <td><a href="${lead.url}" target="_blank">${lead.domain}</a></td>
                                        <td>
                                            <div class="email-list">
                                                ${(lead.emails || []).map(e => `
                                                    <span class="email-badge" title="${e.persona || 'Unknown'}">${e.email}</span>
                                                `).join('')}
                                            </div>
                                        </td>
                                        <td>
                                            ${lead.qualification ? `
                                                <span class="badge badge-${lead.qualification.fit}">${lead.qualification.score}</span>
                                            ` : '-'}
                                        </td>
                                        <td>${new Date(lead.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                document.getElementById('leads-container').innerHTML = `
                    <div class="warning">Failed to load leads: ${error.message}</div>
                `;
            }
        }

        function filterLeads() {
            loadLeads();
        }

        async function loadProductFilters() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                const select = document.getElementById('leads-product-filter');
                select.innerHTML = '<option value="">All Products</option>' +
                    (data.products || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            } catch (error) {
                console.error('Failed to load product filters:', error);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            checkMongoHealth();
            loadProducts();
        });
    </script>
</body>

</html>