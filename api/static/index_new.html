<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generator AI - Real-time Progress</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        label .optional {
            color: #999;
            font-weight: 400;
            font-size: 12px;
        }

        textarea,
        input,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        textarea:focus,
        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            display: none;
        }

        .btn-stop:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .btn-clear {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-clear:hover {
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }

        .progress-section {
            display: none;
            margin: 30px 0;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .progress-badge {
            background: #667eea;
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 13px;
        }

        .step-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .step-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .step-item.thought {
            border-left: 4px solid #667eea;
        }

        .step-item.action {
            border-left: 4px solid #f59e0b;
        }

        .step-item.observation {
            border-left: 4px solid #10b981;
        }

        .step-item.final_answer {
            border-left: 4px solid #ef4444;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-type {
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step-type.thought {
            color: #667eea;
        }

        .step-type.action {
            color: #f59e0b;
        }

        .step-type.observation {
            color: #10b981;
        }

        .step-type.final_answer {
            color: #ef4444;
        }

        .step-number {
            font-size: 12px;
            color: #999;
            font-weight: 600;
        }

        .step-content {
            margin-top: 10px;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .step-content.collapsed {
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .step-content.collapsed::after {
            content: '... (click to expand)';
            position: absolute;
            bottom: 0;
            right: 0;
            background: white;
            padding-left: 20px;
            color: #667eea;
            font-style: italic;
        }

        .step-tool-name {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .results {
            margin-top: 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.6em;
            color: #333;
        }

        .results-count {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .lead-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .lead-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .lead-card.high {
            border-left: 6px solid #10b981;
        }

        .lead-card.medium {
            border-left: 6px solid #f59e0b;
        }

        .lead-card.low {
            border-left: 6px solid #ef4444;
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .lead-name {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .lead-url {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .lead-url:hover {
            text-decoration: underline;
        }

        .lead-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 14px;
        }

        .lead-description {
            color: #555;
            margin-bottom: 14px;
            line-height: 1.6;
        }

        .lead-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            font-size: 14px;
            padding-top: 14px;
            border-top: 1px solid #e0e0e0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-label {
            font-weight: 600;
            color: #666;
        }

        .fit-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
        }

        .fit-badge.high {
            background: #d1fae5;
            color: #065f46;
        }

        .fit-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .fit-badge.low {
            background: #fee2e2;
            color: #991b1b;
        }

        .lead-reason {
            margin-top: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéØ Lead Generator AI</h1>
        <p class="subtitle">Discover and qualify B2B leads with real-time AI research</p>

        <div class="form-grid">
            <div class="form-group form-group-full">
                <label>Product/Service Description *</label>
                <textarea id="product"
                    placeholder="Describe your product/service, what problems it solves, and why customers choose it..."></textarea>
            </div>

            <div class="form-group">
                <label>Target Industries <span class="optional">(optional)</span></label>
                <input type="text" id="industries" placeholder="e.g., Technology, E-commerce, Healthcare">
            </div>

            <div class="form-group">
                <label>Target Regions <span class="optional">(optional)</span></label>
                <input type="text" id="regions" placeholder="e.g., North America, Europe, India">
            </div>

            <div class="form-group">
                <label>Company Size <span class="optional">(optional)</span></label>
                <select id="companySize">
                    <option value="">Any size</option>
                    <option value="startup">Startup (1-50 employees)</option>
                    <option value="SMB">SMB (51-500 employees)</option>
                    <option value="mid-market">Mid-market (501-5000 employees)</option>
                    <option value="enterprise">Enterprise (5000+ employees)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Budget Range <span class="optional">(optional)</span></label>
                <input type="text" id="budget" placeholder="e.g., $10K-50K annually">
            </div>

            <div class="form-group">
                <label>Your Company Name <span class="optional">(optional)</span></label>
                <input type="text" id="sellerCompany" placeholder="e.g., Acme Corp">
            </div>

            <div class="form-group">
                <label>Your Value Proposition <span class="optional">(optional)</span></label>
                <input type="text" id="valueProposition" placeholder="Why customers choose you...">
            </div>

            <div class="form-group">
                <label>Target Lead Count</label>
                <input type="number" id="target" value="30" min="5" max="100">
            </div>

            <div class="form-group">
                <label>Max Search Iterations</label>
                <input type="number" id="iterations" value="5" min="1" max="10">
            </div>
        </div>

        <div class="button-group">
            <button class="btn" id="generateBtn" onclick="generateLeads()">üöÄ Generate Leads</button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopGeneration()">‚õî Stop</button>
            <button class="btn btn-secondary" onclick="loadSavedLeads()">üìÇ View Saved Leads</button>
            <button class="btn btn-clear" onclick="clearAllLeads()">üóëÔ∏è Clear All Leads</button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <div class="progress-title">
                    üß† Agent Progress
                    <span class="loading-spinner" id="spinner"></span>
                </div>
                <div class="progress-badge" id="progressBadge">Running...</div>
            </div>
            <div class="step-list" id="stepList"></div>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        let stepCount = 0;
        let currentReader = null;
        let isRunning = false;

        function stopGeneration() {
            if (currentReader) {
                currentReader.cancel();
                currentReader = null;
            }
            isRunning = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('progressBadge').textContent = 'Stopped';
            document.getElementById('progressBadge').style.background = '#ef4444';
        }

        async function loadSavedLeads() {
            try {
                const response = await fetch('/api/leads');
                if (!response.ok) throw new Error('Failed to load saved leads');

                const leads = await response.json();

                if (leads.length === 0) {
                    alert('üì≠ No saved leads found.');
                    return;
                }

                displayResults(leads);
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert(`‚ùå Error loading saved leads: ${error.message}`);
            }
        }

        async function clearAllLeads() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL saved leads? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/leads', {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to clear leads');

                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                document.getElementById('results').innerHTML = '';

            } catch (error) {
                alert(`‚ùå Error clearing leads: ${error.message}`);
            }
        }

        async function generateLeads() {
            const product = document.getElementById('product').value.trim();
            const target = parseInt(document.getElementById('target').value);
            const iterations = parseInt(document.getElementById('iterations').value);

            if (!product || product.length < 20) {
                alert('‚ö†Ô∏è Please provide a detailed product description (minimum 20 characters)');
                return;
            }

            const industries = document.getElementById('industries').value.trim();
            const regions = document.getElementById('regions').value.trim();
            const companySize = document.getElementById('companySize').value;
            const budget = document.getElementById('budget').value.trim();
            const sellerCompany = document.getElementById('sellerCompany').value.trim();
            const valueProposition = document.getElementById('valueProposition').value.trim();

            const generateBtn = document.getElementById('generateBtn');
            const stopBtn = document.getElementById('stopBtn');
            const progressSection = document.getElementById('progressSection');
            const stepList = document.getElementById('stepList');
            const results = document.getElementById('results');
            const spinner = document.getElementById('spinner');

            generateBtn.disabled = true;
            stopBtn.style.display = 'inline-block';
            isRunning = true;
            progressSection.classList.add('active');
            stepList.innerHTML = '';
            results.innerHTML = '';
            stepCount = 0;
            spinner.style.display = 'inline-block';
            document.getElementById('progressBadge').textContent = 'Running...';
            document.getElementById('progressBadge').style.background = '#667eea';

            const requestBody = {
                product_description: product,
                target_count: target,
                max_iterations: iterations
            };

            if (industries) requestBody.target_industries = industries;
            if (regions) requestBody.target_regions = regions;
            if (companySize) requestBody.company_size = companySize;
            if (budget) requestBody.budget_range = budget;
            if (sellerCompany) requestBody.seller_company = sellerCompany;
            if (valueProposition) requestBody.seller_value_prop = valueProposition;

            try {
                const response = await fetch('/api/generate/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                currentReader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (isRunning) {
                    const { value, done } = await currentReader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            handleStreamEvent(data);
                        }
                    }
                }

                currentReader = null;

            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert(`‚ùå Error: ${error.message}`);
                    console.error(error);
                }
            } finally {
                isRunning = false;
                generateBtn.disabled = false;
                stopBtn.style.display = 'none';
                spinner.style.display = 'none';
                currentReader = null;
            }
        }

        function handleStreamEvent(data) {
            if (data.type === 'start') {
                console.log('Stream started');
            } else if (data.type === 'complete') {
                document.getElementById('progressBadge').textContent =
                    `Complete: ${data.quality} quality leads`;
                document.getElementById('progressBadge').style.background = '#10b981';
            } else if (data.type === 'results') {
                displayResults(data.leads);
            } else if (data.type === 'error') {
                alert(`Error: ${data.message}`);
            } else {
                addStepToUI(data);
            }
        }

        function addStepToUI(step) {
            stepCount++;
            const stepList = document.getElementById('stepList');

            const stepItem = document.createElement('div');
            stepItem.className = `step-item ${step.type}`;

            const toolBadge = step.tool_name ?
                `<span class="step-tool-name">üîß ${step.tool_name}</span>` : '';

            const content = step.content || '';
            const isLong = content.length > 200;

            stepItem.innerHTML = `
                <div class="step-header">
                    <span class="step-type ${step.type}">${getStepIcon(step.type)} ${step.type.replace('_', ' ')}</span>
                    <span class="step-number">#${stepCount}</span>
                </div>
                <div class="step-content ${isLong ? 'collapsed' : ''}">
                    ${content}
                    ${toolBadge}
                </div>
            `;

            if (isLong) {
                stepItem.addEventListener('click', function () {
                    const contentDiv = this.querySelector('.step-content');
                    contentDiv.classList.toggle('collapsed');
                });
            }

            stepList.appendChild(stepItem);
            stepList.scrollTop = stepList.scrollHeight;
        }

        function getStepIcon(type) {
            const icons = {
                'thought': 'üí≠',
                'action': '‚öôÔ∏è',
                'observation': 'üìä',
                'final_answer': '‚úÖ'
            };
            return icons[type] || 'üìå';
        }

        function displayResults(leads) {
            const resultsDiv = document.getElementById('results');

            if (!leads || leads.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #999;">No leads found.</p>';
                return;
            }

            const qualityLeads = leads.filter(l => l.relevance_score >= 50);

            resultsDiv.innerHTML = `
                <div class="results-header">
                    <h2 class="results-title">‚úÖ Generated Leads</h2>
                    <div class="results-count">${qualityLeads.length} Quality Leads (${leads.length} Total)</div>
                </div>
            `;

            const sortedLeads = [...leads].sort((a, b) => b.relevance_score - a.relevance_score);

            sortedLeads.forEach((lead, i) => {
                const card = document.createElement('div');
                card.className = `lead-card ${lead.fit_label}`;

                const emailHtml = lead.extracted_emails && lead.extracted_emails.length > 0 && lead.extracted_emails[0]
                    ? `<div class="meta-item"><span class="meta-label">üìß Email:</span><span>${lead.extracted_emails[0]}</span></div>`
                    : '';

                const phoneHtml = lead.extracted_phone
                    ? `<div class="meta-item"><span class="meta-label">üìû Phone:</span><span>${lead.extracted_phone}</span></div>`
                    : '';

                const linkedinHtml = lead.linkedin_url
                    ? `<div class="meta-item"><span class="meta-label">üíº LinkedIn:</span><a href="${lead.linkedin_url}" target="_blank" class="lead-url">View</a></div>`
                    : '';

                card.innerHTML = `
                    <div class="lead-header">
                        <div>
                            <div class="lead-name">${i + 1}. ${lead.company_name}</div>
                            <a href="${lead.homepage_url}" target="_blank" class="lead-url">${lead.domain}</a>
                        </div>
                        <div class="lead-score">${lead.relevance_score}/100</div>
                    </div>
                    
                    ${lead.short_company_description ?
                        `<p class="lead-description">${lead.short_company_description}</p>` : ''}
                    
                    <div class="lead-meta">
                        <div class="meta-item">
                            <span class="meta-label">Fit:</span>
                            <span class="fit-badge ${lead.fit_label}">${lead.fit_label}</span>
                        </div>
                        ${emailHtml}
                        ${phoneHtml}
                        ${linkedinHtml}
                    </div>
                    
                    ${lead.short_reason_for_score ?
                        `<div class="lead-reason"><strong>üí° Why:</strong> ${lead.short_reason_for_score}</div>` : ''}
                `;

                resultsDiv.appendChild(card);
            });
        }
    </script>
</body>

</html>